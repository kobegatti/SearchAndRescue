<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Search and Rescue</title>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <h1>AI Search and Rescue</h1>

    <form method="POST">
      <h4>Missing Person Type</h4>
      <select ="Missing Person Type" id="missing_person">
        <option value="DAT" id="type">DAT</option>
        <option value="Child" id="type">Child</option>
      </select>
      <h4>Point Last Seen</h4>
      <label for="latitude">Latitude: </label>
      <input
        title="latitude"
        class="sidebar__input"
        type="text"
        name="lat"
        id="latitude"
      />
      <br />
      <label for="longitude">Longitude: </label>
      <input
        title="longitude"
        class="sidebar__input"
        type="text"
        name="lng"
        id="longitude"
      />
      <br /><br />
      <button type="button" onclick="onLoadConfigPress()">
        Find Missing Person
      </button>
      {%csrf_token%}
      <button type="button" onclick="run_function('yah', 'yeet')">Run</button>
    </form>

    <script>
      function run_function(param1, param2) {
        data = {};
        $.ajax({
          url: "random_url/", // the endpoint
          type: "GET", // http method
          data: { param_first: param1, param_second: param2 }, // data sent with the get request
          async: false,

          // handle a successful response
          success: function (json) {
            console.log("JSON = ", json.latitude, json.longitude); // another sanity check
            data = { latitude: json.latitude, longitude: json.longitude };
          },

          // handle a non-successful response
          error: function (xhr, errmsg, err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          },
        });
        return data;
      }
    </script>

    <div id="map" style="width: 100%; height: 600px"></div>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script>
      mapboxgl.accessToken = "{{ mapbox_access_token }}";
      var map = new mapboxgl.Map({
        container: "map", // container ID
        style: "mapbox://styles/mapbox/streets-v11", // style URL
        center: [-78.88945, 38.068585], // starting position [lng, lat] -78.88945, 38.068585 or -79.999732, 40.4374
        zoom: 9, // starting zoom
        projection: "globe", // display the map as a 3D globe
      });

      const predictedLoc = new mapboxgl.Marker().setLngLat([-78.88945, 38.068585]).addTo(map);

      function onLoadConfigPress() {
        var longitude = document.getElementById('longitude').value;
        var latitude = document.getElementById('latitude').value;
        var missing_person_type = document.getElementById('missing_person').value;

        console.log("Type = " + missing_person_type)

        map.setCenter([longitude, latitude]);

        data = run_function(latitude, longitude);
        console.log("data = " + data.latitude, data.longitude);
        predictedLoc.setLngLat([data.longitude, data.latitude]);

        if (missing_person_type == "DAT")
        {
          predictDAT(longitude, latitude);
        }
        else if (missing_person_type == "Child")
        {
          predictChild();
        }
      }

      function predictDAT(longitude, latitude) {
        // If source doesn't exist, add the source
        if (!map.getSource('pointLastSeen'))
        {
          map.addSource("pointLastSeen", {
            "type": "geojson",
            "data": {
              "type": "FeatureCollection",
              "features": [{
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  "coordinates": [longitude, latitude]
                }
              }]
            }
          });
        }
        else // update the center location of exisiting source
        {
          map.getSource("pointLastSeen").setData({
            "type": "geojson",
              "type": "FeatureCollection",
              "features": [{
                "type": "Feature",
                "geometry": {
                  "type": "Point",
                  "coordinates": [longitude, latitude]
                }
              }]
          });
        }

        const metersToPixelsAtMaxZoom = (meters, latitude) =>
          meters / 0.075 / Math.cos(latitude * Math.PI / 180)

        if (map.getLayer('outerCircle') !== undefined)
        {
          map.removeLayer('outerCircle');
        }

        map.addLayer({
          "id": "outerCircle",
          "type": "circle",
          "source": "pointLastSeen",
          "paint": {
            "circle-radius": {
              stops: [
                [0, 0],
                [20, metersToPixelsAtMaxZoom(1300, latitude)] // 1.3 km
              ],
              base: 2
            },
            "circle-color": "red",
            "circle-opacity": 0.1
          }
        });

        if (map.getLayer('middleCircle') !== undefined)
        {
          map.removeLayer('middleCircle');
        }

        map.addLayer({
          "id": "middleCircle",
          "type": "circle",
          "source": "pointLastSeen",
          "paint": {
            "circle-radius": {
              stops: [
                [0, 0],
                [20, metersToPixelsAtMaxZoom(800, latitude)] // 0.8 km
              ],
              base: 2
            },
            "circle-color": "red",
            "circle-opacity": 0.2
          }
        });

      }

      function predictChild() {
        console.log("Child Heurisitics here");
      }
        // add heatmap layer here



      {% for address in addresses %}
      // Create a new marker.
      var marker = new mapboxgl.Marker().setLngLat([{{ address.long }}, {{ address.lat }}]).setPopup(new mapboxgl.Popup().setHTML('<p>{{ address.address }}<\p>')).addTo(map);
      //var marker = new mapboxgl.Marker().setLngLat([30.5, 50.5]).addTo(map);
      {% endfor %}
    </script>
  </body>
</html>
